---
output:
  pdf_document
---

## Appendix A : Outliers {-}
```{r echo = FALSE, message = FALSE, warning = FALSE,  results='asis'}
#Packages
if (!require("utils")) install.packages("utils")
if (!require("car")) install.packages("car")
if (!require("dplyr")) install.packages("dplyr")
if (!require("plm")) install.packages("plm")
if (!require("stargazer")) install.packages("stargazer")
library(stargazer)
library(plm)
library(utils)
library(car)
library(dplyr)

#Database
DB_Lag1<-as.data.frame(read.csv2("Analysis/DataBase/Lag_1.csv", sep = ";",stringsAsFactors=FALSE, header = TRUE ))

```

First I measure the cook's distance of my models. Observations that have a cook’s distance greater than 4 times the mean are considered as influential and are summarized in figures \ref{OutliersRoa}, \ref{OutliersTobinsQ} and \ref{OutliersRoe}. 




<!--Secondly, in order to detect the influence of those outliers, I use the function *outlierTest* from the *car* package [@Fox2012]. This function reports the Bonferroni p-values for Studentized residuals in linear and generalized linear models, based on a t-test for linear models and normal-distribution test for generalized linear models. -->

```{r echo = FALSE, message = FALSE, warning = FALSE, fig.align = 'center', fig.width = 6, fig.height = 6, results = 'asis'}

#############################################################
#############################################################
######## Model without EnergyProductivity as VIF = 5 ########
#############################################################
#############################################################


#####################################
######### Cooks Distance ############
#####################################

# I define my models in lm as cooks.distance do not support plm object
Roa <-lm(ROA ~ SustainabilityPayLink + SustainableThemedCommitment + AuditScore + CarbonProductivity + WaterProductivity + WasteProductivity + Leverage + NetMargin + FirmSize + Industry, data = DB_Lag1)

TobinsQ<-lm(TobinsQ ~ SustainabilityPayLink + SustainableThemedCommitment + AuditScore + CarbonProductivity + WaterProductivity + WasteProductivity + Leverage + NetMargin + FirmSize + Industry, data = DB_Lag1)

Roe <- lm(TobinsQ ~ SustainabilityPayLink + SustainableThemedCommitment + AuditScore + CarbonProductivity + WaterProductivity + WasteProductivity + Leverage + NetMargin + FirmSize + Industry, data = DB_Lag1)

## I calculate my cooks distance (i.e. D)
cooksdRoa <- cooks.distance(Roa)
cooksdTobinsQ <- cooks.distance(TobinsQ)
cooksdRoe <- cooks.distance(Roe)

## I extract rows considered as influential (observations whose D > 4 * means)

influentialRoa <- as.numeric(names(cooksdRoa)[(cooksdRoa > 4*mean(cooksdRoa, na.rm=T))])  
influentialTobin <- as.numeric(names(cooksdTobinsQ)[(cooksdTobinsQ > 4*mean(cooksdTobinsQ, na.rm=T))])  
influentialRoe <- as.numeric(names(cooksdRoe)[(cooksdRoe > 4*mean(cooksdRoe, na.rm=T))])  

head(DB_Lag1[influentialRoa, ])  # influential observations - number = 2 
head(DB_Lag1[influentialTobin, ])  # influential observations - number = 40
head(DB_Lag1[influentialRoe, ])  # influential observations - number = 38


#I remove outliers and create three new data frames

DB_Lag1_NoOutliers <- DB_Lag1[-c(influentialTobin,influentialRoa),]
DB_Roa_NoOut <- DB_Lag1[-c(influentialRoa),]
DB_Roe_NoOut <- DB_Lag1[-c(influentialRoe),]


#########################################################
######### Plm vith new dataset (no outliers) ############
#########################################################

#############################
###### Model 1 : ROA ########
#############################

#Model 1 with outliers with EnergyProductivity
Roa1<-plm(ROA ~ SustainabilityPayLink + SustainableThemedCommitment + AuditScore + CarbonProductivity + EnergyProductivity + WaterProductivity + WasteProductivity + Leverage + NetMargin + FirmSize + Industry, data = DB_Lag1, index = c("Companies", "YearFinancialIndicator"), model = "random") 

#Model 1 without outliers with EnergyProductivity
Roa2 <-plm(ROA ~ SustainabilityPayLink + SustainableThemedCommitment + AuditScore + CarbonProductivity + EnergyProductivity + WaterProductivity + WasteProductivity + Leverage + NetMargin + FirmSize + Industry , data = DB_Roa_NoOut, index = c("Companies", "YearFinancialIndicator"), model = "random") 

#Model 1 with outliers without EnergyProductivity
Roa3 <-plm(ROA ~ SustainabilityPayLink + SustainableThemedCommitment + AuditScore + CarbonProductivity + WaterProductivity + WasteProductivity + Leverage + NetMargin + FirmSize + Industry, data = DB_Lag1, index = c("Companies", "YearFinancialIndicator"), model = "random") 

#Model 1 without outliers without EnergyProductivity
Roa4 <-plm(ROA ~ SustainabilityPayLink + SustainableThemedCommitment + AuditScore + CarbonProductivity + WaterProductivity + WasteProductivity + Leverage + NetMargin + FirmSize + Industry , data = DB_Roa_NoOut, index = c("Companies", "YearFinancialIndicator"), model = "random") 

#Model process-based CEP without outliers

Roa5 <- plm(ROA ~ SustainabilityPayLink + SustainableThemedCommitment + AuditScore + Leverage + NetMargin + FirmSize + Industry , data = DB_Roa_NoOut, index = c("Companies", "YearFinancialIndicator"), model = "random") 

#Model outcome-based CEP without outliers

Roa6 <- plm(ROA ~ CarbonProductivity + WaterProductivity + WasteProductivity + Leverage + NetMargin + FirmSize + Industry , data = DB_Roa_NoOut, index = c("Companies", "YearFinancialIndicator"), model = "random")

#############################
#### Model 2 : Tobin's Q ####
#############################

#Mode2 with outliers
Tobins1 <- plm(TobinsQ ~ SustainabilityPayLink + SustainableThemedCommitment + AuditScore + CarbonProductivity + WaterProductivity + WasteProductivity + Leverage + NetMargin + FirmSize + Industry, data = DB_Lag1, index = c("Companies", "YearFinancialIndicator"), model = "random")

#Mode2 without the 40 outliers from Tobin's Q
Tobins3 <-plm(TobinsQ ~ SustainabilityPayLink + SustainableThemedCommitment + AuditScore +  CarbonProductivity + WaterProductivity + WasteProductivity + Leverage + NetMargin + FirmSize + Industry, data = DB_Lag1_NoOutliers, index = c("Companies", "YearFinancialIndicator"), model = "random")

#############################
###### Model 3 : ROE ########
#############################

#Mode3 with outliers
Roe1<-plm(ROE ~ SustainabilityPayLink + SustainableThemedCommitment + AuditScore + CarbonProductivity + WaterProductivity + WasteProductivity + Leverage + NetMargin + FirmSize + Industry, data = DB_Lag1, index = c("Companies", "YearFinancialIndicator"), model = "random") 

#Model3 without the 38 outliers from ROE
Roe2 <-plm(ROE ~ SustainabilityPayLink + SustainableThemedCommitment + AuditScore + CarbonProductivity + WaterProductivity + Leverage + NetMargin + FirmSize + Industry , data = DB_Roe_NoOut, index = c("Companies", "YearFinancialIndicator"), model = "random") 


#########################################################
######### My Stargazer's friend do the rest #############
#########################################################


TableRoaEn <- stargazer(Roa1, Roa2, type="latex", label = "Roa1", title = "Model 1 - Energy", header = FALSE)

TableRoaNoEn <- stargazer(Roa3, Roa4, type="latex", label = "Roa2", title = "Model 1 - No Energy", header = FALSE)

TableRoaShort1 <- stargazer(Roa5, type="latex", label = "Roa3", title = "Model 1 - Short Version", header = FALSE)

TableRoaShort2 <- stargazer(Roa6, type="latex", label = "Roa4", title = "Model 1 - Short Version", header = FALSE)

TableTobinsQ <- stargazer(Tobins1, Tobins3, type="latex", label = "Tobin", title = "Model 2 - Comparaison with and without outliers", header = FALSE)

TableRoe <- stargazer(Roe1, Roe2, type="latex", label = "Roe", title = "Model 3 - Comparaison with and without outliers", header = FALSE)
```



```{r}
####################################
######### Hausman Test #############
####################################



#Model without the 2 outliers from ROA
Roa2_Fixed <-plm(ROA ~ SustainabilityPayLink + SustainableThemedCommitment + AuditScore + CarbonProductivity + WaterProductivity + Leverage + NetMargin + FirmSize + Industry , data = DB_Roa_NoOut, index = c("Companies", "YearFinancialIndicator"), model = "within") 

#Mode2 without the 40 outliers from Tobin's Q
Tobins3_Fixed <-plm(TobinsQ ~ SustainabilityPayLink + SustainableThemedCommitment + AuditScore +  CarbonProductivity + WaterProductivity + WasteProductivity + Leverage + NetMargin + FirmSize + Industry, data = DB_Lag1_NoOutliers, index = c("Companies", "YearFinancialIndicator"), model = "within")

#Model3 without the 38 outliers from ROE
Roe2_Fixed <-plm(ROE ~ SustainabilityPayLink + SustainableThemedCommitment + AuditScore + CarbonProductivity + WaterProductivity + Leverage + NetMargin + FirmSize + Industry , data = DB_Roe_NoOut, index = c("Companies", "YearFinancialIndicator"), model = "within") 


HausmannRoa <-  cbind("Model 1 without outliers",phtest(Roa2_Fixed,Roa2)$p.value)
HausmannTobinsQ <-  cbind("Model 2 without outliers",phtest(Tobins3_Fixed,Tobins3)$p.value)
HausmannRoe <-  cbind("Model 3 without outliers",phtest(Roe2_Fixed,Roe2)$p.value)

HausmanTable <- rbind(HausmannRoa, HausmannTobinsQ, HausmannRoe)
colnames(HausmanTable) <- c("Model","P-Value")

stargazer(HausmanTable, summary = FALSE, table.placement = "h", type="latex", label = "Hausman", title = "Hausman Test PValue", header = FALSE)

```







\begin{figure}[ht]
\caption{Observations considered as outliers in model 1 (i.e. Roa)}
\label{OutliersRoa}
```{r echo = FALSE, message = FALSE, warning = FALSE, fig.align = 'center', fig.width = 6, fig.height = 6, results = 'asis'}

#Model Roa
## I summarise on a graph, those observations that have a cook’s distance greater than 4 times the mean and which may be considered as outliers
plot(cooksdRoa, pch="*", cex=2)  # plot cook's distance
abline(h = 4*mean(cooksdRoa, na.rm=T), col="red")  # add cutoff line
text(x=1:length(cooksdRoa)+1, y=cooksdRoa, labels=ifelse(cooksdRoa>4*mean(cooksdRoa, na.rm=T),names(cooksdRoa),""), col="red")  # add labels
```
\end{figure}



\begin{figure}[ht]
\caption{Observations considered as outliers in model 2 (i.e. Tobin's Q)}
\label{OutliersTobinsQ}
```{r echo = FALSE, message = FALSE, warning = FALSE, fig.align = 'center', fig.width = 6, fig.height = 6, results = 'asis'}


#Model TobinsQ
plot(cooksdTobinsQ, pch="*", cex=2)  

abline(h = 4*mean(cooksdTobinsQ, na.rm=T), col="red")  # add cutoff line
text(x=1:length(cooksdTobinsQ)+1, y=cooksdTobinsQ, labels=ifelse(cooksdTobinsQ>4*mean(cooksdTobinsQ, na.rm=T),names(cooksdTobinsQ),""), col="red")  # add labels

```
\end{figure}


\begin{figure}[ht]
\caption{Observations considered as outliers in model 1 (i.e. Roe)}
\label{OutliersRoe}
```{r echo = FALSE, message = FALSE, warning = FALSE, fig.align = 'center', fig.width = 6, fig.height = 6, results = 'asis'}

#Model Roe
## I summarise on a graph, those observations that have a cook’s distance greater than 4 times the mean and which may be considered as outliers
plot(cooksdRoe, pch="*", cex=2)  # plot cook's distance
abline(h = 4*mean(cooksdRoe, na.rm=T), col="red")  # add cutoff line
text(x=1:length(cooksdRoe)+1, y=cooksdRoe, labels=ifelse(cooksdRoe>4*mean(cooksdRoe, na.rm=T),names(cooksdRoe),""), col="red")  # add labels
```
\end{figure}
