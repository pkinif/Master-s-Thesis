---
output: 
  pdf_document 
header-includes:
   - \usepackage{rotating}
   -  \usepackage{dcolumn}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, error = FALSE, results = 'hide')
```

```{r}

#############################################################
#############################################################
############## Package and DataBase loading #################
#############################################################
#############################################################


rm(list=ls()) #Removes all items in Environment!
if (!require("plm")) install.packages("plm")
library(plm) # to carry outregression
if (!require("dplyr")) install.packages("dplyr")
library(dplyr) # to play with data
if (!require("Hmisc")) install.packages("Hmisc")
library(Hmisc) 
if (!require("utils")) install.packages("utils")
library(utils) #to dowload db
if (!require("corrplot")) install.packages("corrplot")
library(corrplot) #correlation matrix
if (!require("stargazer")) install.packages("stargazer")
library(stargazer) #beautiful table
if (!require("xtable")) install.packages("xtable")
library(xtable) #beautiful table
if (!require("car")) install.packages("car")
library(car) #VIF calculation

# I dowload my DB with read.csv2


Roa_Lag1_NoOut<-data.frame(read.csv2("DataBase/NoOutliers/Tobins_Lag1_NoOut.csv", sep = ";",stringsAsFactors = FALSE, header = TRUE )) 
Roe_Lag1_NoOut<-data.frame(read.csv2("DataBase/NoOutliers/Roe_Lag1_NoOut.csv", sep = ";",stringsAsFactors=FALSE, header = TRUE ))
Tobins_Lag1_NoOut<-data.frame(read.csv2("DataBase/NoOutliers/Tobins_Lag1_NoOut.csv", sep = ";",stringsAsFactors=FALSE, header = TRUE ))
Return_Lag1_NoOut<-data.frame(read.csv2("DataBase/NoOutliers/Return_Lag1_NoOut.csv", sep = ";",stringsAsFactors=FALSE, header = TRUE ))



#I select only important variables of my model

Model <- Roa_Lag1_NoOut [,c("ROA", "ROE", "TobinsQ", "Ra",
                                  "CarbonProductivity", "WaterProductivity", 
                                  "WasteProductivity",
                                  "SustainabilityPayLink", "SustainableThemedCommitment",
                                  "FirmSize", "Leverage", "NetMargin", "AlphaJensen")]

```

The \autoref{Matrix} is the matrix correlation.

According to Miroschynenko blabla :

> *The authors observe statistically significant correlations between green practices’ measures suggesting that multicollinearity might be a problem. The variance inflation factors (VIF) of all the independent and control variables were calculated to test the effects of multicollinearity in the regression analysis. The mean VIF values in all the models (with a minimum of 2.76 and maximum of 2.82) indicate the absence of the multicollinearity (O’Brien, 2007).*

Let's calculate the VIF of my models. For this process I need to use the pool model to caclculate the VIF of each variable. The \autoref{VIF} summarizes the VIF of my models. We can observe that the mean VIF values of my models are ... meaning the absence of multicollinearity [@Obrien2007]

```{r results = 'asis'}

#############################################################
#############################################################
############## Variance Inflation Factor ####################
#############################################################
#############################################################

#The vif function can not be used with within model. I need to estimate my models with the pooling model.

Roa <- plm(ROA ~ SustainabilityPayLink + SustainableThemedCommitment + AuditScore + CarbonProductivity + WaterProductivity + WasteProductivity + Leverage + NetMargin + FirmSize + Industry + AlphaJensen, model = "pooling", data = Roa_Lag1_NoOut, index = c("Companies", "Year"))

TobinsQ <- plm(TobinsQ ~ SustainabilityPayLink + SustainableThemedCommitment + AuditScore + CarbonProductivity + WaterProductivity + WasteProductivity + Leverage + NetMargin + FirmSize + Industry + AlphaJensen, model = "pooling", data = Tobins_Lag1_NoOut, index = c("Companies", "Year"))

Roe <- plm(ROE ~ SustainabilityPayLink + SustainableThemedCommitment + AuditScore + CarbonProductivity + WaterProductivity + WasteProductivity + Leverage + NetMargin + FirmSize + Industry + AlphaJensen , model = "pooling", data = Roe_Lag1_NoOut, index = c("Companies", "Year"))

Return <- plm(Ra ~ SustainabilityPayLink + SustainableThemedCommitment + AuditScore + CarbonProductivity + WaterProductivity + WasteProductivity + Leverage + NetMargin + FirmSize + Industry + AlphaJensen , model = "pooling", data = Return_Lag1_NoOut, index = c("Companies", "Year"))

#VIF Calculation and summary in a table

VifRoa <- car::vif(Roa)
VifRoe <- car::vif(Roe)
VifTobin <- car::vif(TobinsQ)
VifReturn <- car::vif(Return)


VifTable <- cbind(VifRoa, VifTobin, VifRoe, VifReturn)
colnames(VifTable) <- c("Roa", "Roe", "Tobin's Q", "Stock Return")

stargazer(VifTable, summary = FALSE, title = "The Variance Inflation Factors - Measure of Multicollinearity", label = "VIF", header = FALSE)

```



```{r}


#############################################################
#############################################################
################## Matrix of Correlation ####################
#############################################################
#############################################################

corstars <-function(x, method=c("pearson", "spearman"), removeTriangle=c("upper", "lower"), result=c("none", "html", "latex")){
  
    #Compute correlation matrix
    require(Hmisc)
    x <- as.matrix(x)
    correlation_matrix<-rcorr(x, type=method[1])
    R <- correlation_matrix$r # Matrix of correlation coeficients
    p <- correlation_matrix$P # Matrix of p-value 
    
    ## Define notions for significance levels; spacing is important.
    mystars <- ifelse(p < .01, "*** ", ifelse(p < .05, "**  ", ifelse(p < .1, "*   ", "    ")))
    
    ## trunctuate the correlation matrix to two decimal
    R <- format(round(cbind(rep(-1.11, ncol(x)), R), 2))[,-1]
    
    ## build a new matrix that includes the correlations with their apropriate stars
    Rnew <- matrix(paste(R, mystars, sep=""), ncol=ncol(x))
    diag(Rnew) <- paste(diag(R), " ", sep="")
    rownames(Rnew) <- colnames(x)
    colnames(Rnew) <- paste(colnames(x), "", sep="")
    
    ## remove upper triangle of correlation matrix
    if(removeTriangle[1]=="upper"){
      Rnew <- as.matrix(Rnew)
      Rnew[upper.tri(Rnew, diag = TRUE)] <- ""
      Rnew <- as.data.frame(Rnew)
    }
    
    ## remove lower triangle of correlation matrix
    else if(removeTriangle[1]=="lower"){
      Rnew <- as.matrix(Rnew)
      Rnew[lower.tri(Rnew, diag = TRUE)] <- ""
      Rnew <- as.data.frame(Rnew)
    }
    
    ## remove last column and return the correlation matrix
    Rnew <- cbind(Rnew[1:length(Rnew)-1])
    if (result[1]=="none") return(Rnew)
    else{
      if(result[1]=="html") print(xtable(Rnew), type="html")
      else print(xtable(Rnew), type="latex") 
    }
} 


CorMatrix <- corstars(Model, method = "pearson",removeTriangle = "upper",  result = "none")

upper<-CorMatrix
upper[upper.tri(CorMatrix)]<-""
upper<-as.data.frame(upper)

old_names <- upper[,1]
number<-as.character(cbind(1:13)) #number of variables
number_bis<-as.character(cbind(1:12)) #number of variables less 1

colnames(upper)<-number_bis
variables <- as.character(rownames(upper))
NewName <- paste(number, variables, sep = ". ")
rownames(upper) <- NewName

options(xtable.comment = FALSE)


#table <- xtable(upper, caption = "Correlation Matrix", label = "corr")

table <- stargazer(upper, summary = FALSE, type = "latex", title = "Correlation Matrix" , label = "Matrix", float=TRUE, float.env = "sidewaystable", header = FALSE, table.placement = "h", column.sep.width = "2pt",font.size = "small")

# I have tried everything and I can not add notes at the table. Idem I can note align to the left. I will have to do that manually.
```

\begin{sidewaystable}[h] \centering  
  \caption{Matrix of correlation} 
  \label{MatrixCo} 
\small 
\begin{tabular}{@{\extracolsep{2pt}} lllllllllllll}  
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & 10 & 11 & 12 \\ 
\hline \\[-1.8ex] 
1. ROA &  &  &  &  &  &  &  &  &  &  &  &  \\ 
2. ROE &  0.37\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  &  &  &  &  &  &  &  &  &  &  \\ 
3. TobinsQ &  0.29\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  0.12\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  &  &  &  &  &  &  &  &  &  \\ 
4. Ra &  0.13\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  0.03     &  0.05     &  &  &  &  &  &  &  &  &  \\ 
5. CarbonProductivity &  0.04     &  0.06\textasteriskcentered     & -0.05     &  0.14\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  &  &  &  &  &  &  &  \\ 
6. WaterProductivity &  0.06\textasteriskcentered \textasteriskcentered    &  0.09\textasteriskcentered \textasteriskcentered \textasteriskcentered   & -0.03     &  0.12\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  0.65\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  &  &  &  &  &  &  \\ 
7. WasteProductivity &  0.04     &  0.10\textasteriskcentered \textasteriskcentered \textasteriskcentered   & -0.04     &  0.12\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  0.56\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  0.70\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  &  &  &  &  &  \\ 
8. SustainabilityPayLink & -0.05     &  0.08\textasteriskcentered \textasteriskcentered \textasteriskcentered   & -0.13\textasteriskcentered \textasteriskcentered \textasteriskcentered   & -0.05     &  0.09\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  0.16\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  0.17\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  &  &  &  &  \\ 
9. SustainableThemedCommitment & -0.04     &  0.10\textasteriskcentered \textasteriskcentered \textasteriskcentered   & -0.14\textasteriskcentered \textasteriskcentered \textasteriskcentered   & -0.01     &  0.23\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  0.29\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  0.25\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  0.49\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  &  &  &  \\ 
10. FirmSize & -0.29\textasteriskcentered \textasteriskcentered \textasteriskcentered   & -0.08\textasteriskcentered \textasteriskcentered    & -0.55\textasteriskcentered \textasteriskcentered \textasteriskcentered   & -0.01     &  0.06\textasteriskcentered \textasteriskcentered    &  0.07\textasteriskcentered \textasteriskcentered    &  0.05\textasteriskcentered     &  0.29\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  0.28\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  &  &  \\ 
11. Leverage & -0.06\textasteriskcentered     & -0.14\textasteriskcentered \textasteriskcentered \textasteriskcentered   & -0.02     & -0.01     & -0.01     &  0.00     &  0.00     &  0.01     &  0.00     &  0.03     &  &  \\ 
12. NetMargin &  0.38\textasteriskcentered \textasteriskcentered \textasteriskcentered   & -0.01     & -0.06\textasteriskcentered     &  0.15\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  0.03     &  0.01     &  0.01     &  0.02     & -0.01     &  0.10\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  0.08\textasteriskcentered \textasteriskcentered    &  \\ 
13. AlphaJensen &  0.10\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  0.03     &  0.07\textasteriskcentered \textasteriskcentered    &  0.92\textasteriskcentered \textasteriskcentered \textasteriskcentered   & -0.02     & -0.01     &  0.00     &  0.01     &  0.00     &  0.01     & -0.02     &  0.14\textasteriskcentered \textasteriskcentered \textasteriskcentered   \\ 
\hline
\hline \\[-1.8ex] 
\textit{Note:}  & \multicolumn{10}{r}{$^{*}$p$<$0.1; $^{**}$p$<$0.05; $^{***}$p$<$0.01} \\
\end{tabular} 
\end{sidewaystable}

