---
output: 
  pdf_document 
header-includes:
   - \usepackage{rotating}
   -  \usepackage{dcolumn}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, error = FALSE, results = 'hide')
```
```{r}
#Download package and database
rm(list=ls()) #Removes all items in Environment!
if (!require("plm")) install.packages("plm")
library(plm)
if (!require("dplyr")) install.packages("dplyr")
library(dplyr)
if (!require("utils")) install.packages("utils")
library(utils)
if (!require("Hmisc")) install.packages("Hmisc")
library(Hmisc)
if (!require("corrplot")) install.packages("corrplot")
library(corrplot)
if (!require("stargazer")) install.packages("stargazer")
library(stargazer)
if (!require("xtable")) install.packages("xtable")
library(xtable)

# I dowload my database befor knitting
# I dowload my DB with read.csv2


DB_Lag1<-data.frame(read.csv2("DataBase/Lag_1.csv", sep = ";",stringsAsFactors=FALSE, header = TRUE ))


#I select only variables of my model

DB_Lag1_Model <- select(DB_Lag1, ROA, ROE, TobinsQ, EnergyProductivity,
                        CarbonProductivity, WaterProductivity, WasteProductivity,
                        SustainabilityPayLink, SustainableThemedCommitment, 
                        FirmSize, Leverage, NetMargin)

#DataBase without outliers for VIF calculation
Lag1_Roa_NoOutliers<-data.frame(read.csv2("DataBase/NoOutliers/Lag1_Roa_NoOutliers.csv", sep = ";",stringsAsFactors=FALSE, header = TRUE ))

Lag1_Roe_NoOutliers<-data.frame(read.csv2("DataBase/NoOutliers/Lag1_Roa_NoOutliers.csv", sep = ";",stringsAsFactors=FALSE, header = TRUE ))

#For Tobin I have decided to use the database with outliers. So I will use the DB_Lag1 database


```

The \autoref{Matrix} is the matrix correlation.

According to Miroschynenko blabla :

> *The authors observe statistically significant correlations between green practices’ measures suggesting that multicollinearity might be a problem. The variance inflation factors (VIF) of all the independent and control variables were calculated to test the effects of multicollinearity in the regression analysis. The mean VIF values in all the models (with a minimum of 2.76 and maximum of 2.82) indicate the absence of the multicollinearity (O’Brien, 2007).*

Let's calculate the VIF of my models. For this process I need to use the pool model to caclculate the VIF of each variable. The \autoref{VIF} summarizes the VIF of my models. We can observe that the mean VIF values of my models are ... meaning the absence of multicollinearity [@Obrien2007]

```{r results = 'asis'}
if (!require("car")) install.packages("car")
library(car)

#The vif function can not be used with within model. I need to estimate my models with the pooling model.

Roa1_NoOut <- plm(ROA ~ SustainabilityPayLink + SustainableThemedCommitment + AuditScore + EnergyProductivity + CarbonProductivity + WaterProductivity + WasteProductivity + Leverage + NetMargin + FirmSize + Industry , model = "pooling", data = Lag1_Roa_NoOutliers, index = c("Companies", "YearFinancialIndicator"))

Tobin1_Out <- plm(TobinsQ ~ SustainabilityPayLink + SustainableThemedCommitment + AuditScore + EnergyProductivity + CarbonProductivity + WaterProductivity + WasteProductivity + Leverage + NetMargin + FirmSize + Industry , model = "pooling", data = DB_Lag1, index = c("Companies", "YearFinancialIndicator"))

Roe1_NoOut <- plm(ROE ~ SustainabilityPayLink + SustainableThemedCommitment + AuditScore + EnergyProductivity + CarbonProductivity + WaterProductivity + WasteProductivity + Leverage + NetMargin + FirmSize + Industry , model = "pooling", data = Lag1_Roa_NoOutliers, index = c("Companies", "YearFinancialIndicator"))

#VIF Calculation and summary in a table

VifRoa <- car::vif(Roa1_NoOut)
VifRoe <- car::vif(Roe1_NoOut)
VifTobin <- car::vif(Tobin1_Out)

VifTable <- cbind(VifRoa, VifRoe, VifTobin)
colnames(VifTable) <- c("Roa", "Roe", "Tobin's Q")

stargazer(VifTable, summary = TRUE, title = "The Variance Inflation Factors - Measure of Multicollinearity", label = "VIF", header = FALSE)
```



```{r}
corstars <-function(x, method=c("pearson", "spearman"), removeTriangle=c("upper", "lower"), result=c("none", "html", "latex")){
  
    #Compute correlation matrix
    require(Hmisc)
    x <- as.matrix(x)
    correlation_matrix<-rcorr(x, type=method[1])
    R <- correlation_matrix$r # Matrix of correlation coeficients
    p <- correlation_matrix$P # Matrix of p-value 
    
    ## Define notions for significance levels; spacing is important.
    mystars <- ifelse(p < .01, "*** ", ifelse(p < .05, "**  ", ifelse(p < .1, "*   ", "    ")))
    
    ## trunctuate the correlation matrix to two decimal
    R <- format(round(cbind(rep(-1.11, ncol(x)), R), 2))[,-1]
    
    ## build a new matrix that includes the correlations with their apropriate stars
    Rnew <- matrix(paste(R, mystars, sep=""), ncol=ncol(x))
    diag(Rnew) <- paste(diag(R), " ", sep="")
    rownames(Rnew) <- colnames(x)
    colnames(Rnew) <- paste(colnames(x), "", sep="")
    
    ## remove upper triangle of correlation matrix
    if(removeTriangle[1]=="upper"){
      Rnew <- as.matrix(Rnew)
      Rnew[upper.tri(Rnew, diag = TRUE)] <- ""
      Rnew <- as.data.frame(Rnew)
    }
    
    ## remove lower triangle of correlation matrix
    else if(removeTriangle[1]=="lower"){
      Rnew <- as.matrix(Rnew)
      Rnew[lower.tri(Rnew, diag = TRUE)] <- ""
      Rnew <- as.data.frame(Rnew)
    }
    
    ## remove last column and return the correlation matrix
    Rnew <- cbind(Rnew[1:length(Rnew)-1])
    if (result[1]=="none") return(Rnew)
    else{
      if(result[1]=="html") print(xtable(Rnew), type="html")
      else print(xtable(Rnew), type="latex") 
    }
} 


CorMatrix <- corstars(DB_Lag1_Model, method = "pearson",removeTriangle = "upper",  result = "none")

upper<-CorMatrix
upper[upper.tri(CorMatrix)]<-""
upper<-as.data.frame(upper)

old_names <- upper[,1]
number<-as.character(cbind(1:12))
number_bis<-as.character(cbind(1:11))

colnames(upper)<-number_bis
variables <- as.character(rownames(upper))
NewName <- paste(number, variables, sep = ". ")
rownames(upper) <- NewName

options(xtable.comment = FALSE)


#table <- xtable(upper, caption = "Correlation Matrix", label = "corr")

table <- stargazer(upper, summary = FALSE, type = "latex", title = "Correlation Matrix" , label = "Matrix", float=TRUE, float.env = "sidewaystable", header = FALSE, table.placement = "h", column.sep.width = "2pt",font.size = "small")

# I have tried everything and I can not add notes at the table. Idem I can note align to the left. I will have to do that manually.
```

\begin{sidewaystable}[h] \centering  
  \caption{Correlation Matrix} 
  \label{Matrix} 
\small 
\begin{tabular}{@{\extracolsep{2pt}} p{4cm}lllllllllll} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & 10 & 11 \\ 
\hline \\[-1.8ex] 
1. ROA &  &  &  &  &  &  &  &  &  &  &  \\ 
2. ROE &  0.23\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  &  &  &  &  &  &  &  &  &  \\ 
3. TobinsQ &  0.15\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  0.03     &  &  &  &  &  &  &  &  &  \\ 
4. EnergyProductivity &  0.07\textasteriskcentered \textasteriskcentered    &  0.02     & -0.02     &  &  &  &  &  &  &  &  \\ 
5. CarbonProductivity &  0.07\textasteriskcentered \textasteriskcentered    &  0.02     & -0.02     &  0.88\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  &  &  &  &  &  &  \\ 
6. WaterProductivity &  0.08\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  0.03     & -0.03     &  0.64\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  0.67\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  &  &  &  &  &  \\ 
7. WasteProductivity &  0.05\textasteriskcentered     &  0.02     & -0.04     &  0.49\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  0.56\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  0.69\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  &  &  &  &  \\ 
8. SustainabilityPayLink & -0.04     &  0.06\textasteriskcentered \textasteriskcentered    & -0.13\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  0.04     &  0.06\textasteriskcentered \textasteriskcentered    &  0.14\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  0.15\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  &  &  &  \\ 
9. SustainableThemedCommitment & -0.02     &  0.08\textasteriskcentered \textasteriskcentered \textasteriskcentered   & -0.14\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  0.23\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  0.22\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  0.26\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  0.24\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  0.48\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  &  &  \\ 
10. FirmSize & -0.26\textasteriskcentered \textasteriskcentered \textasteriskcentered   & -0.02     & -0.51\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  0.04     &  0.07\textasteriskcentered \textasteriskcentered    &  0.08\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  0.07\textasteriskcentered \textasteriskcentered    &  0.28\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  0.27\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  &  \\ 
11. Leverage & -0.02     &  0.07\textasteriskcentered \textasteriskcentered    & -0.02     & -0.01     & -0.02     & -0.01     & -0.01     & -0.02     & -0.02     &  0.14\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  \\ 
12. NetMargin &  0.33\textasteriskcentered \textasteriskcentered \textasteriskcentered   &  0.05\textasteriskcentered     & -0.06\textasteriskcentered \textasteriskcentered    &  0.02     &  0.02     &  0.01     &  0.01     &  0.04     &  0.02     &  0.04     &  0.00     \\ 
\hline
\hline \\[-1.8ex] 
\textit{Note:}  & \multicolumn{11}{r}{$^{*}$p$<$0.1; $^{**}$p$<$0.05; $^{***}$p$<$0.01} \\
\end{tabular} 
\end{sidewaystable}

