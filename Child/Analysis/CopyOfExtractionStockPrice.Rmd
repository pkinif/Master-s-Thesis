
```{r}

#############################################################
#############################################################
############## Package and DataBase loading #################
#############################################################
#############################################################


rm(list=ls()) #Removes all items in Environment!
if (!require("dplyr")) install.packages("dplyr")
library(dplyr) # to play with data
if (!require("utils")) install.packages("utils")
library(utils) #to dowload db
if (!require("xts")) install.packages("xts")
library(xts) 
if (!require("PerformanceAnalytics")) install.packages("PerformanceAnalytics")
library(PerformanceAnalytics) 
if (!require("tibble")) install.packages("tibble")
library(tibble) 
if (!require("tidyquant")) install.packages("tidyquant")
library(tidyquant) 

# I dowload my ticker's list

Companies <- read.csv2("DataBase/Companies.csv", sep = ";", header = TRUE, stringsAsFactors = FALSE)

Ticker <- Companies$Ticker


##################################
####### Extraction ###############
##################################

if (!require("pdfetch")) install.packages("pdfetch")
library(pdfetch) # to web scrap from yahoo

Yahoo_AdjClose<- pdfetch_YAHOO(Ticker, fields = "adjclose", from = as.Date("2011-12-01"), interval = "1mo")

Yahoo_Volume<- pdfetch_YAHOO(Ticker, fields = "volume", from = as.Date("2011-12-01"), interval = "1mo")

# Could not find series 'BF.A'Could not find series 'BRK.A'Could not find series 'DISH�'Could not find series 'HLT�'Could not find series 'INCY�'Could not find series 'MGM�'Could not find series 'SBAC�'

###################################
####### AdjClose DF ###############
###################################

StockPrice <- as.data.frame(Yahoo_AdjClose)
StockPrice1 <- as.data.frame(t(StockPrice))
StockPrice2 <- rownames_to_column(StockPrice1, var = "Ticker")
StockPrice3 <- StockPrice2 %>% 
  gather(Date,AdjClose, 2:81)

###################################
####### Volume DF #################
###################################

Volume <- as.data.frame(Yahoo_Volume)
Volume1 <- as.data.frame(t(Volume))
Volume2 <- rownames_to_column(Volume1, var = "Ticker")

Volume3 <- Volume2 %>% 
  gather(Date,Volume, 2:81)

#############################################
########### Compounded Return ###############
#############################################

CompoundedReturn <- Return.calculate(Yahoo_AdjClose, method = "log")
CompoundedReturn1 <- as.data.frame(t(CompoundedReturn))
CompoundedReturn2 <- rownames_to_column(CompoundedReturn1, var = "Ticker")
CompoundedReturn3 <- CompoundedReturn2 %>% 
  gather(Date,CompoundedReturn, 2:81)


###################################
####### Merging ###################
###################################

MarketDb <- cbind(StockPrice3, Volume3, CompoundedReturn3)
MarketDb1 <- MarketDb[,-c(4,5,7,8)]
MarketDb1$Date <- as.Date(MarketDb1$Date)


#####################################
####### Rm and Rf ###################
#####################################

#I dowload the FamaAndFrench DataBase that I get on http://mba.tuck.dartmouth.edu/pages/faculty/ken.french/Data_Library/f-f_factors.html



FF <- read.table("DataBase/StockPrice/FF.txt", header = TRUE, sep = "", stringsAsFactors = FALSE, row.names = NULL, col.names = c("Date","Mkt-RF", "SMB", "HML", "RF"))

#The date colone is not well written so I remove it
FF1 <- FF[,-c(1)]

#I create a monthly date vector
Date <- seq(as.Date("1926/7/1"), as.Date("2018/02/1"), by = "month")

#I cbind date vector and FF dataframe
FF2 <- cbind(Date,FF1)

#Fama and French give us Rm-Rf in the Mkt.Rf. I create a column which is Rm

FF2["Rm"] <- FF2$Mkt.RF + FF2$RF

#############################################
########### Jensen's Alpha ##################
#############################################

#I merge FF2 and MarketDB1 together based on date

MarketIndicators <- merge(MarketDb1, FF2, by = "Date")

# Now I need to compute the Beta of the CAMP formula which is basically the cov(Ra,Rm)/Var(Rm) with Ra the return of the stock, namely the compounded return and Rm the return of the market. I will use the tidyquant package with the tq_performance function.


###################################################
########### TidyQuant Package !! ##################
###################################################

##################################
#######Get CompoundedReturn#######
##################################

Ra <- Ticker %>%
  tq_get(get  = "stock.prices",
         from = "2010-01-01",
         to   = "2016-12-31") %>%
  group_by(symbol) %>%
  tq_transmute(select     = adjusted, 
               mutate_fun = periodReturn, 
               period     = "monthly",
               type       = "log",
               col_rename = "Ra")

# In order to mergeRb with FamaFrench I need to make date column in same format. Here in Ra we have yyyy-mm-dd but dd is not always 01 which is a problem for merging.
Ra["DayBis"] <- "01"

Ra_1 <- Ra %>%
  separate(col = "date", into = c("Year", "Month", "Day"), sep = "-") %>%
  unite(col = "date", Year, Month, DayBis, sep = "-")

Ra_2 <- Ra_1[,c("symbol","date", "Ra")]

Ra_2$date <- as.Date(Ra_2$date)


# Get returns for SP500 as baseline

Rb <- "^GSPC" %>%
    tq_get(get  = "stock.prices",
           from = "2010-01-01",
           to   = "2016-12-31") %>%
    tq_transmute(select     = adjusted, 
               mutate_fun = periodReturn, 
               period     = "monthly",
               type       = "log",
               col_rename = "Rb")


##################################
#######Get FAMA FRENCH Db#########
##################################


FF <- read.table("DataBase/StockPrice/FF.txt", header = TRUE, sep = "", stringsAsFactors = FALSE, row.names = NULL, col.names = c("date","Mkt-RF", "SMB", "HML", "RF"))

#The date colone is not well written so I remove it
FF1 <- FF[,-c(1)]

#I create a monthly date vector
date <- seq(as.Date("1926/7/1"), as.Date("2018/02/1"), by = "month")

#I cbind date vector and FF dataframe
FF2 <- cbind(date,FF1)

#I only need two columns for the CAPM analysis, mkt.rf and rf, so let’s select them.

FamaFrench <- FF2  %>%
    select(date, Mkt.RF, RF)


# Value in FamaFrench are in %, I need to divide by 100

FamaFrench1 <- FamaFrench %>%
  transform(RF_Base100 = RF/100) %>%
  transform(Mkt.RF_Base100 = Mkt.RF/100)

FamaFrench2 <- FamaFrench1[,c("date", "RF_Base100", "Mkt.RF_Base100")]

#Merge FamaFrench et Ra

joined_data <- merge(Ra_2, FamaFrench2, by = "date")

#Remembering that the left side of the CAPM formula is stock return minus the risk free rate, I calculate that as well.

joined_data["Ra-Rf"] <- joined_data$Ra - joined_data$RF_Base100

##################################
####### Rolling CAPM #########
##################################






# Merge stock returns with baseline
RaRb <- left_join(Ra, Rb, by = c("date" = "date"))

# Compute CAPM
CAPM <- RaRb %>%
    tq_performance(Ra = Ra, Rb = Rb, performance_fun = table.CAPM)

write.csv2(CAPM, file = "DataBase/StockPrice/AlphaBeta.csv")

```

