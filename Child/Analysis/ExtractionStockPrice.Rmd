---
title: "Extraction Stock Price"
author: "Kinif Pierrick"
date: "16 avril 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}

#############################################################
#############################################################
############## Package and DataBase loading #################
#############################################################
#############################################################


rm(list=ls()) #Removes all items in Environment!
if (!require("dplyr")) install.packages("dplyr")
library(dplyr) # to play with data
if (!require("utils")) install.packages("utils")
library(utils) #to dowload db


# I dowload my ticker's list

Companies <- read.csv2("DataBase/Companies.csv", sep = ";", header = TRUE, stringsAsFactors = FALSE)

Ticker <- Companies$Ticker


##################################
####### Extraction ###############
##################################

if (!require("pdfetch")) install.packages("pdfetch")
library(pdfetch) # to web scrap from yahoo

Yahoo<- pdfetch_YAHOO(Ticker, fields = c("close","volume"), from = as.Date("2012-12-01"), interval = "1mo")

# BCR, BHI, CAM, DD, DOW, HLT, INCY, MGM, RAI, SNDK, TWC and YHOO are not listed in the Yahoo dataframe. I will have to find another platform to get those data

# I select only data that I want
Date <- c("2012-12-01","2013-12-01","2014-12-01","2015-12-01","2016-12-01")
YahooSample<-as.data.frame(Yahoo[Date,])

#Tidy my data
if (!require("tidyverse")) install.packages("tidyverse")
library(tidyverse) 
if (!require("dplyr")) install.packages("dplyr")
library(dplyr) 

YahooSample0 <- t(YahooSample) #transpose row into colums and vice versa
colnames(YahooSample0)<-c("2012","2013","2014","2015","2016") #renames my colnames

YahooSample1 <- as.data.frame(YahooSample0)
YahooSample2 <- rownames_to_column(YahooSample1, var = "test")
write.csv2(YahooSample2,"DataBase/StockPrice/YahooSample2.csv")

#From here I had to split the first column 'test' with excel because the separate function below do not work.... So I will makje an other chunk an restart the process in dowloading the csv file where changes were made manually. Basicaly I write YahooSample 2 as YahooSample2.csv. Then I open it in excel, I split test into c("Ticker", "Variable"). I format columns in number and then I save in YahooSample4.csv

#YahooSample3 <- separate(data = YahooSample2, col = test, into = c("Ticker","Variable"), sep = ".", fill = "left")
```


```{r}

# doowloading the csv file where changes were made manually, namely YahooSample 2 became YahooSample4. I open YahooSample4.
YahooSample4 <- read.csv2(file = "DataBase/StockPrice/YahooSample4.csv", header = TRUE, stringsAsFactors = FALSE )

View(YahooSample4)
colnames(YahooSample4)<-c("Ticker","Variables","2012","2013","2014","2015","2016") #renames my colnames


# I make two dataset that I will merger after. It is only to make the use of 'gather'  more easy
CriteriumA <- "close"
CriteriumB <- "volume"

YahooSample5A <- filter(YahooSample4, Variables %in% CriteriumA)
YahooSample5B <- filter(YahooSample4, Variables %in% CriteriumB)

#Use of gather

YahooSample6A <- YahooSample5A %>%
  gather(`2012`, `2013`, `2014`, `2015`,`2016`, key = "year", value = "Close")

YahooSample6B <- YahooSample5B %>%
  gather(`2012`, `2013`, `2014`, `2015`,`2016`, key = "year", value = "volume")


#I merge both data

YahooSample7 <-  merge(YahooSample6A, YahooSample6B, by = c("Ticker", "year"))

#I keep only some columns to avoid dupplicates

YahooSample8 <- YahooSample7[,c("Ticker", "year", "Close", "volume")]

#I rename colnames one last time
colnames(YahooSample8) <- c("Ticker", "Year", "Close", "Volume")
View(YahooSample8)
str(YahooSample8)#I check if close and volume are as.numeric format

#I write YahooSample 8 as csv file

write.csv2(YahooSample8, "DataBase/StockPrice/YahooSample8.csv")
```

