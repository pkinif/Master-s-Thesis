
```{r}

#############################################################
#############################################################
############## Merging all data together ####################
#############################################################
#############################################################

rm(list=ls()) #Removes all items in Environment!
if (!require("dplyr")) install.packages("dplyr")
library(dplyr) # to play with data
if (!require("utils")) install.packages("utils")
library(utils) #to dowload db
if (!require("tibble")) install.packages("tibble")
library(tibble) 
if (!require("lubridate")) install.packages("lubridate")
library(lubridate) 
if (!require("tidyr")) install.packages("tidyr")
library(tidyr)
if (!require("data.table")) install.packages("data.table")
library(data.table)



# This file syncronize data from from StockPup, NewsWeekGreen Ranking, Companies and Tobin'sQ from Ycharts. 

# I download each DataBase

  StockPup <- read.csv(file = "DataBase/StockPup/StkP_From2012.csv", header = TRUE, stringsAsFactors = FALSE) # NB : StockPup is already merged with the file Companies.
  
  CAPM <- read.csv(file = "DataBase/CAPM/CAPM.csv", header = TRUE, stringsAsFactors = FALSE)
  
  NewsWeek <- read.csv2( file = "DataBase/NewsWeekGreenRanking_1416.csv", header = TRUE, stringsAsFactors = FALSE)
  
  TobinsQ <-  read.csv2( file = "DataBase/TobinsQ_1216.csv", header = TRUE, stringsAsFactors = FALSE)

  Companies <- read.csv2( file = "DataBase/Companies.csv", header = TRUE, stringsAsFactors = FALSE)
  
# I restructure each DB in removing some useless columns
  
  
  ## StockPup
  StockPup1 <- select(StockPup, -c(X, Date,
                             Companies,
                             GisSector,
                             GicsClassification,
                             FichierSTCKP,
                             CompanyGR2014,
                             CompanyGR2015,
                             CompanyGR2016
                             ))
  StockPup1[,2:42] <- sapply(StockPup1[,2:42], as.numeric)
  
  ## CAPM
  CAPM1 <- select(CAPM, -c(X,
                           Date))
  
  ## TobinsQ
  TobinsQ1 <- select(TobinsQ, -Companies)
  
  
  ## Newsweek
  NewsWeek1 <- select(NewsWeek, -Companies)
  


  # All Database contains a column Ticker and Year except Newsweek which do not have a year column. I create one for each lag. 
  
  ## For lag(0) --> - 2 as newsweek GR ranking 2014,2015, 2016 are calculated based on companies data in 2012,2013,2014
  
    NewsWeek_Lag0 <- NewsWeek1
    NewsWeek_Lag0$Year <- NewsWeek_Lag0$YearNewsWeekGR - 2
  
    ## Lag 1
    
    NewsWeek_Lag1 <- NewsWeek1
    NewsWeek_Lag1$Year <- NewsWeek_Lag1$YearNewsWeekGR - 1
    
    ## Lag 2
    
    NewsWeek_Lag2 <- NewsWeek1
    NewsWeek_Lag2$Year <- NewsWeek_Lag2$YearNewsWeekGR 
    
    ## Lag 3
    
    NewsWeek_Lag3 <- NewsWeek1
    NewsWeek_Lag3$Year <- NewsWeek_Lag3$YearNewsWeekGR + 1
    

##########################################
############### Merging ##################
##########################################

# First I merge StockPup, CAPM and TobinsQ together
    
    
    Syncro <- merge(StockPup1, TobinsQ1, by = c("Ticker", "Year"), all = TRUE)
    Syncro1 <- merge(Syncro, CAPM1, by = c("Ticker", "Year"), all = TRUE)
    Syncro2 <- merge(Companies, Syncro1, by = c("Ticker"), all = TRUE)

# I rename columns

    OldNames <- c("Shares.split.adjusted", 
                  "Split.factor", 
                  "Currents.Assets", 
                  "Current.Assets",	
                  "Liabilities",	
                  "Current.Liabilities",	
                  "Shareholders.equity",	
                  "Non.controlling.interest",	
                  "Preferred.equity",	
                  "Goodwill...intangibles",	
                  "Long.term.debt",	
                  "Revenue",	
                  "Earnings",	
                  "Earnings.available.for.common.stockholders",	
                  "EPS.basic",	
                  "EPS.diluted",	
                  "Dividend.per.share",	
                  "Cash.from.operating.activities",	
                  "Cash.from.investing.activities",	
                  "Cash.from.financing.activities",	
                  "Cash.change.during.period",	
                  "Cash.at.end.of.period",	
                  "Capital.expenditures",	
                  "Price",	
                  "Price.high",	
                  "Price.low",	
                  "ROE",	
                  "ROA",	
                  "Book.value.of.equity.per.share",	
                  "P.B.ratio",	
                  "P.E.ratio",	
                  "Cumulative.dividends.per.share",	
                  "Dividend.payout.ratio",	
                  "Long.term.debt.to.equity.ratio",	
                  "Equity.to.assets.ratio",	
                  "Net.margin",	
                  "Asset.turnover",	
                  "Free.cash.flow.per.share",	
                  "Current.ratio")

    NewNames <- c()

    Syncro3 <- Syncro2 %>% setnames(old = c("Shares.split.adjusted", "Split.factor"), new = c("SharesSplitAdjusted", "SplitFactor"))
    
# Then I merge with NewsWeek for each lag  
    
    ## First I need to select a time period of 3 years for each lag
    
      ### Lag 0

        SyncroLag0 <- Syncro2 %>% 
          subset( Year > 2011) %>%
          subset(Year < 2015)
    
        FullDb_Lag0 <- merge(SyncroLag0, NewsWeek_Lag0, by = c("Ticker", "Year"), all = TRUE)
        
      ### Lag 1

        SyncroLag1 <- Syncro2 %>% 
          subset( Year > 2012) %>%
          subset(Year < 2016)
    
        FullDb_Lag1 <- merge(SyncroLag1, NewsWeek_Lag1, by = c("Ticker", "Year"), all = TRUE)
        
      ### Lag 2

        SyncroLag2 <- Syncro2 %>% 
          subset( Year > 2013) %>%
          subset(Year < 2017)
    
        FullDb_Lag2 <- merge(SyncroLag2, NewsWeek_Lag2, by = c("Ticker", "Year"), all = TRUE)

      ### Lag 3

        SyncroLag3 <- Syncro2 %>% 
          subset( Year > 2014) %>%
          subset(Year < 2018)
    
        FullDb_Lag3 <- merge(SyncroLag3, NewsWeek_Lag3, by = c("Ticker", "Year"), all = TRUE)           
        
        


# Finaly I write as csv :)
    
    write.csv(FullDb_Lag0, file = "DataBase/FullDb_Lag0.csv")
    write.csv(FullDb_Lag1, file = "DataBase/FullDb_Lag1.csv")
    write.csv(FullDb_Lag2, file = "DataBase/FullDb_Lag2.csv")
    write.csv(FullDb_Lag3, file = "DataBase/FullDb_Lag3.csv")

```

