---
output:
  pdf_document
---

```{r include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, error = FALSE, warning = FALSE, results = 'asis')
```


```{r}

################################################
############## Package loading #################
################################################

rm(list=ls()) #Removes all items in the R environment
if (!require("plm")) install.packages("plm")
library(plm) 
if (!require("dplyr")) install.packages("dplyr")
library(dplyr) 
if (!require("data.table")) install.packages("data.table")
library(data.table)
if (!require("stargazer")) install.packages("stargazer")
library(stargazer)
```

# Sensitivity Analysis

Sensitivity Analysis (SA) investigates how the variation in the output of a numerical model can be attributed to variations of its input factors [@Pianosi2016]. To ensure the robustness of the main findings of the previous section I have carried out two robustness tests. 

Firstly the equation \ref{EconometricModel} had been re-estimated using dependent variables accelerated by one year in a sense that observations in independent and control variables are now lagged two year behind corporate financial performance. Based on the results of the table \ref{Lag2Test}, estimators of both TobinsQ and Roa
model had been estimated with the *pooled ols estimation*. Results are reported in table \ref{Lag2} and confirms results of the previous section.

Secondly, I have used an alternative proxy for approaching corporate environmental performance, namely the Green Score assigned to each company of the NewsWeek Green Ranking. The score is based on a weighted average of the key performance indicators of the ranking. Concretely, it means that equation \ref{EconometricModel} becomes the following equation.

\begin{equation}
\centering
Y_{it+1} = \alpha + \beta_{1} GS_{it} + Controls_{it} + u_{it}
\label{GreenScoreEquation}
\end{equation}


where \(Y_{it+1}\) is a proxy of CFP measured as ROA or Tobin's Q, \(GS_{it}\) is a proxy for a firm's green score, \(Controls_{it}\) is a vector of control variables that includes firm size, industry sector, financial leverage and growth and lastly \(u_{it}\) which is the error term.

Based on the results of p-value of table \ref{GreenScoreTests}, equation \ref{GreenScoreEquation} had been estimated with the *pooled ols estimators* (for TobinsQ) and the *fixed effect estimation* (for Roa). Results are reported in table \ref{GreenScoreResults} and confirms findings of the previous section. Consequently, the sensitivity analysis supports that CEP do have a significant and positive effect on CFP (short and long-term). 


```{r}
################################################
######## The impact of CEP on CFP ##############
################################################

# I have already removed outliers from both model (i.e. Roa and TobinsQ) through the file = "Analysis/MakeFile_RemoveOutliers_Lag1.rmd". Consequently I just need to download them in this file.
RoaNoOut <- read.csv(file = "Analysis/DataBase/DataSynchronization/NoOutliersLag2/Roa.csv", header = TRUE, stringsAsFactors = FALSE)

TobinNoOut <- read.csv(file = "Analysis/DataBase/DataSynchronization/NoOutliersLag2/TobinsQ.csv", header = TRUE, stringsAsFactors = FALSE)
 
# I make both df a plm dataframe
RoaNoOut <- RoaNoOut %>% pdata.frame(index = c("CompaniesIndex", "YearIndex"))
TobinNoOut <- TobinNoOut %>% pdata.frame(index = c("CompaniesIndex", "YearIndex"))

# I test for Random Effect Model using the Lagrange Multiplier Tests for Panel Models. 

  ## Pooling Model
  RoaPooling <- plm(Roa ~ SustainabilityPayLink + SustainableThemedCommitment + AuditScore + CarbonProductivity + WaterProductivity + WasteProductivity + FirmSize + FinancialLeverage + Growth + Industry, data = RoaNoOut, model="pooling")
  TobinPooling <- plm(TobinsQ ~ SustainabilityPayLink + SustainableThemedCommitment + AuditScore + CarbonProductivity + WaterProductivity + WasteProductivity + FirmSize + FinancialLeverage + Growth + Industry, data = TobinNoOut, model="pooling")


  ## Plmtest
  PlmtestRoa <- cbind("Roa", round(plmtest(RoaPooling, effect = "time", type = "bp")$p.value, digits = 4))
  PlmtestTobin <- cbind("TobinsQ", round(plmtest(TobinPooling, effect = "time", type = "bp")$p.value, digits = 4))

  
  ## I consolidate into a table for later reporting 
  CfpPlmTest <- as.data.frame(rbind(PlmtestRoa, PlmtestTobin))
  colnames(CfpPlmTest) <- c("DependentVariables", "Plmtest")
  rownames(CfpPlmTest) <- c()
  CfpPlmTest[,2] <- as.numeric(as.character(CfpPlmTest[,2]))  

  ## Improve p-value understanding
  CfpPlmTest$Plmtest<-ifelse(CfpPlmTest$Plmtest<0.01, paste(CfpPlmTest$Plmtest,"***",sep = ""),
		ifelse(CfpPlmTest$Plmtest<0.05,paste(CfpPlmTest$Plmtest,"**",sep = ""),
		ifelse(CfpPlmTest$Plmtest<0.1,paste(CfpPlmTest$Plmtest,"*",sep = ""),CfpPlmTest$Plmtest)))
 
  
# I test for Fixed Effect Model using pFtest which is a test of individual and/or time effects based on the comparison of the within and the pooling model.
  
  ## Within Model with time effect
  
  RoaWithin <- plm(Roa ~ SustainabilityPayLink + SustainableThemedCommitment + AuditScore + CarbonProductivity + WaterProductivity + WasteProductivity + FirmSize + FinancialLeverage + Growth + Industry, data = RoaNoOut, model="within", effect = "time")
  TobinWithin <- plm(TobinsQ ~ SustainabilityPayLink + SustainableThemedCommitment + AuditScore + CarbonProductivity + WaterProductivity + WasteProductivity + FirmSize + FinancialLeverage + Growth + Industry, data = TobinNoOut, model = "within", effect = "time")
  
  ## pFtest
  
  pFtestRoa <- cbind("Roa", round(pFtest(RoaWithin, RoaPooling)$p.value, digits = 4))
  
  pFtestTobin <- cbind("TobinsQ", round(pFtest(TobinWithin, TobinPooling)$p.value, digits = 4))
  

  ## I consolidate into a table for later reporting 
  CfppFtest <- as.data.frame(rbind(pFtestRoa, pFtestTobin))
  colnames(CfppFtest) <- c("DependentVariables", "pFtest")
  rownames(CfppFtest) <- c()
  CfppFtest[,2] <- as.numeric(as.character(CfppFtest[,2]))  

  ## Improve p-value understanding
  CfppFtest$pFtest<-ifelse(CfppFtest$pFtest<0.01, paste(CfppFtest$pFtest,"***",sep = ""),
		ifelse(CfppFtest$pFtest<0.05,paste(CfppFtest$pFtest,"**",sep = ""),
		ifelse(CfppFtest$pFtest<0.1,paste(CfppFtest$pFtest,"*",sep = ""),CfppFtest$pFtest)))


# I consolidate the p-value of the two tests into a nice stargazer table 

  NiceTable <- merge(CfpPlmTest, CfppFtest, by = "DependentVariables")
  colnames(NiceTable) <- c("Dependent Variables", "Lagrange Multiplier Test", "F Test")
  stargazer(NiceTable, summary = FALSE, title = "P-value Reporting", label = "Lag2Test", align = TRUE, type = "latex", header = FALSE, notes = "Note : * p<0.1; ** p<0.05; *** p<0.01", notes.align = "r" )
  
# Based on the results of the tests, the three models need to be estimated with the fixed effects estimations (i.e. model = "within" in plm). Let's consolidate into a stargazer table
  
  stargazer(TobinPooling, RoaPooling, title = "Robustness check : The impact of both process-based and outcome-based CEP on CFP with lag = 2", label = "Lag2", header = FALSE, type = "latex")

```

```{r}
################################################
######## The impact of CEP on CFP ##############
################################################

# I have already removed outliers from both model (i.e. Roa and TobinsQ) through the file = "Analysis/MakeFile_RemoveOutliers_Lag1.rmd". Consequently I just need to download them in this file.
RoaNoOut <- read.csv(file = "Analysis/DataBase/DataSynchronization/NoOutliersLag1/GreenScore/Roa.csv", header = TRUE, stringsAsFactors = FALSE)

TobinNoOut <- read.csv(file = "Analysis/DataBase/DataSynchronization/NoOutliersLag1/GreenScore/TobinsQ.csv", header = TRUE, stringsAsFactors = FALSE)
 
# I make both df a plm dataframe
RoaNoOut <- RoaNoOut %>% pdata.frame(index = c("CompaniesIndex", "YearIndex"))
TobinNoOut <- TobinNoOut %>% pdata.frame(index = c("CompaniesIndex", "YearIndex"))

# I test for Random Effect Model using the Lagrange Multiplier Tests for Panel Models. 

  ## Pooling Model
  RoaPooling <- plm(Roa ~ GreenScore + FirmSize + FinancialLeverage + Growth + Industry, data = RoaNoOut, model="pooling")
  TobinPooling <- plm(TobinsQ ~ GreenScore + FirmSize + FinancialLeverage + Growth + Industry, data = TobinNoOut, model="pooling")


  ## Plmtest
  PlmtestRoa <- cbind("Roa", round(plmtest(RoaPooling, effect = "time", type = "bp")$p.value, digits = 4))
  PlmtestTobin <- cbind("TobinsQ", round(plmtest(TobinPooling, effect = "time", type = "bp")$p.value, digits = 4))

  
  ## I consolidate into a table for later reporting 
  CfpPlmTest <- as.data.frame(rbind(PlmtestRoa, PlmtestTobin))
  colnames(CfpPlmTest) <- c("DependentVariables", "Plmtest")
  rownames(CfpPlmTest) <- c()
  CfpPlmTest[,2] <- as.numeric(as.character(CfpPlmTest[,2]))  

  ## Improve p-value understanding
  CfpPlmTest$Plmtest<-ifelse(CfpPlmTest$Plmtest<0.01, paste(CfpPlmTest$Plmtest,"***",sep = ""),
		ifelse(CfpPlmTest$Plmtest<0.05,paste(CfpPlmTest$Plmtest,"**",sep = ""),
		ifelse(CfpPlmTest$Plmtest<0.1,paste(CfpPlmTest$Plmtest,"*",sep = ""),CfpPlmTest$Plmtest)))
 
  
# I test for Fixed Effect Model using pFtest which is a test of individual and/or time effects based on the comparison of the within and the pooling model.
  
  ## Within Model with time effect
  
  RoaWithin <- plm(Roa ~ GreenScore + FirmSize + FinancialLeverage + Growth + Industry, data = RoaNoOut, model = "within", effect = "time")
  TobinWithin <- plm(TobinsQ ~ GreenScore + FirmSize + FinancialLeverage + Growth + Industry, data = TobinNoOut, model = "within", effect = "time")
  
  ## pFtest
  
  pFtestRoa <- cbind("Roa", round(pFtest(RoaWithin, RoaPooling)$p.value, digits = 4))
  
  pFtestTobin <- cbind("TobinsQ", round(pFtest(TobinWithin, TobinPooling)$p.value, digits = 4))
  

  ## I consolidate into a table for later reporting 
  CfppFtest <- as.data.frame(rbind(pFtestRoa, pFtestTobin))
  colnames(CfppFtest) <- c("DependentVariables", "pFtest")
  rownames(CfppFtest) <- c()
  CfppFtest[,2] <- as.numeric(as.character(CfppFtest[,2]))  

  ## Improve p-value understanding
  CfppFtest$pFtest<-ifelse(CfppFtest$pFtest<0.01, paste(CfppFtest$pFtest,"***",sep = ""),
		ifelse(CfppFtest$pFtest<0.05,paste(CfppFtest$pFtest,"**",sep = ""),
		ifelse(CfppFtest$pFtest<0.1,paste(CfppFtest$pFtest,"*",sep = ""),CfppFtest$pFtest)))


# I consolidate the p-value of the two tests into a nice stargazer table 

  NiceTable <- merge(CfpPlmTest, CfppFtest, by = "DependentVariables")
  colnames(NiceTable) <- c("Dependent Variables", "Lagrange Multiplier Test", "F Test")
  stargazer(NiceTable, summary = FALSE, title = "P-value Reporting", label = "GreenScoreTests", align = TRUE, type = "latex", header = FALSE, notes = "Note : * p<0.1; ** p<0.05; *** p<0.01", notes.align = "r" )
  
# Based on the results of the tests, the three models need to be estimated with the fixed effects estimations (i.e. model = "within" in plm). Let's consolidate into a stargazer table
  
  stargazer(TobinPooling, RoaWithin, title = "Robustness check : alternative variable for CEP", label = "GreenScoreResults", header = FALSE, type = "latex")

```
